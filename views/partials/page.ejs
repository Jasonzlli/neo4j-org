<%
// console.log(path,neo4j);
var pageName = path.substring(path.lastIndexOf('/')+1, path.length);
var mainCategory = path.split('/')[1];
var page = pages[pageName];
var badge = page.badge;

//badge = '<h2>Foo</h2><p class="introText">Bar</p><p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.</p><p>At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>s';


var title=page.title;
// console.log(page);
%>

<% include ../head %>
<% if (badge) { %>
    <div class="badge">
        <div class="close"><img src="/assets/new/img/close_button.png"></div>
        <%- badge %>
    </div>
<% } %>
<%
if (page) {
%>
<div class="page"><!-- page -->
    <% if (page.title) { %>
<h1><%= page.title %></h1>
    <% } %>


<% (page.prev||[]).forEach(function(p) {
var prevPage = pages[p];
  %>
    <div class="btn trackNav prevStep"><a href="<%= prevPage.path %>"><i class="icon icon-circle-arrow-left"></i></a><a href="<%= prevPage.path %>"><%= prevPage.title %></a></div>
<%
});
%>

<% (page.next||[]).forEach(function(p) {
var nextPage = pages[p];
  %>
    <div class="btn trackNav nextStep"><a href="<%= nextPage.path %>"><%= nextPage.title %></a> <a href="<%= nextPage.path %>"><i class="icon icon-circle-arrow-right"></i></a></div>
<%
});
%>

<div class="clear"></div>

    <% if (page.introText) { %>
<p class="introText"><%- page.introText %></p>
    <% } %>
    <% if (page.content) { %>
<p class="content"><%- typeof page.content == "function" ? page.content(locals) : page.content %></p>
    <% } %>



<% 
    var items = [].concat(page.featured);
    var config = page.config || {};
    var showSlides = items.length > 1 && !config['no_slides'];
    if (page.featured && items.length) {

//        console.log("featured-items",items);
    %><% if (showSlides) { %><div id="featured_slider"><ul class="bjqs"><% } %><%
            items.forEach(function(key) { 
            var item = findItem(key);
//            console.log("featured",item);
    %>
        <% if (showSlides) { %> 
            <li title="<%= item.title||'' %>">
            <% include ../partials/item/_full %>
            </li>
        <% } else { %>
            <% include ../partials/item/_full %>
        <% } }); %>
        <% if (showSlides) { %>
            </ul></div>
        <% } %><%
   } %>

<%
    if (page.related && page.related.length) { 
//      console.log("page-related",page.related);
%>    
    <div class="related" class="mainElement">

            <% chunk(page.related,4).forEach(function(row) { %>
                <div class="row">
                <% 
                row.forEach(function(key) { 

                    var item = findItem(key);
                      %> <% include ../partials/item/_tile %> <%
                });  %> 

                </div><!-- row -->
                <div class="clear"></div>

         <% }); %>
                    
    </div><!-- related -->

<% } %>

</div><!-- page -->
<script type="text/javascript">

    $(document).ready(function() {
        var timeout;
        function init() {
            clearTimeout(timeout);
            if ($(".page").height()==0) {
                timeout=setTimeout(init,250);
            }
            var ref = $('#featured_slider');
            var offset = 224;
    
            if (!ref.length) {
                ref = $('div.featured');
                offset = 240;
                if (!ref.length) {
                    ref = $('div.related');
                    offset = 224;
                }
            }
            var featuredTop = ref.first().offset().top;
            
        }

        var region="<%= region %>";
    	
    	function filterByRegion(region) {
            var elements=$("div[area]");
            if (elements.length==0) return; 
        	elements.each(function() {
        		var area = $(this).attr("area");
        		if (!area || area=='WORLD' || region=='WORLD' || area==region) $(this).show();
        		else $(this).hide();
        	})
            nav.resize();
        }
    	$("#region").val(region).change(function() {
    	    filterByRegion($(this).val());
    	})
//    	filterByRegion(region);
        
        nav.activateMain('<%= mainCategory%>');
        nav.initThumbnails();
        
        init();
    });


</script>
<% } %>        

<% include ../foot %>

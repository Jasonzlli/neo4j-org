(function(){function r(){t.data([e]).call(n)}function i(e){localStorage.setItem("graph-diagram-markup",e)}function u(t){var n=null;var r=gd.parameters.radius*e.internalScale();var i=e.nodeList();for(var s=0;s<i.length;s++){var o=i[s];if(o!==t){var u=t.distanceTo(o)*e.internalScale();if(u<r){n=o;r=u}}}return n}function a(){var t=window.event.shiftKey;var n=d3.select(this);var i=n[0][0].__data__;if(!s&&t){s=e.createNode().x(i.x()+d3.event.dx).y(i.y()+d3.event.dy);s.isNew=true;o=e.createRelationship(i,s)}if(s){var a=u(s);if(a&&a!=i){o.end=a;s.isNew=false}else{o.end=s;s.isNew=true}i=s}i.drag(d3.event.dx,d3.event.dy);r()}function f(){if(s){if(o&&o.end!==s){e.deleteNode(s)}s.isNew=false}s=null;i(h());r()}function l(){function u(){t.label(s.node().value);t.properties().clearAll();o.node().value.split("\n").forEach(function(e){var n=e.split(/: */);if(n.length===2){var r=n[0].trim();var i=n[1].trim();if(r.length>0&&i.length>0){t.properties().set(r,i)}}});i(h());r();p()}function a(){e.deleteNode(t);i(h());r();p()}d();d3.select(".modal.pop-up-editor.node").classed("hide",false);var t=this.__data__;var n=d3.select(".pop-up-editor.node");n.select("path").attr("d",gd.speechBubblePath({width:500,height:200},"diagonal",gd.parameters.speechBubbleMargin,gd.parameters.speechBubblePadding));var s=n.select("#node_caption");s.node().value=t.label()||"";s.node().select();var o=n.select("#node_properties");o.node().value=t.properties().list().reduce(function(e,t){return e+t.key+": "+t.value+"\n"},"");n.select("#edit_node_save").on("click",u);n.select("#edit_node_delete").on("click",a)}function c(){var e=this.__data__;var n=e.start.midwayTo(e.end);var s=t.append("svg:foreignObject").attr("x",n.x-50).attr("y",n.y-50).attr("height",100).attr("width",120).append("xhtml:body").append("input").attr("class","editor-field").style("width",100+"px");s.node().value=e.label()||"";s.node().select();s.on("keypress",function(){var t=d3.event;if(t.which==10||t.which==13){e.label(s.node().value);s.remove();i(h());r()}})}function h(){var t=d3.select("body").append("div");gd.markup.format(e,t);var n=t.node().innerHTML;n=n.replace(/<li/g,"\n  <li").replace(/<span/g,"\n    <span").replace(/<\/span><\/li/g,"</span>\n  </li").replace(/<\/ul/,"\n</ul");t.remove();return n}function p(){d3.selectAll(".modal").classed("hide",true);d3.selectAll(".modal-backdrop").remove()}function d(){d3.select("body").append("div").attr("class","modal-backdrop").on("click",p)}function y(e){var t=d3.select("body").append("div");t.node().innerHTML=e;var n=gd.markup.parse(t.select("ul.graph-diagram-markup"));t.remove();return n}function T(){e.internalScale(d3.select("#internalScale").node().value);r()}var e;if(localStorage.getItem("graph-diagram-markup")){e=y(localStorage.getItem("graph-diagram-markup"))}else{e=gd.model();e.createNode().x(50).y(140)}var t=d3.select("#canvas").append("svg:svg").attr("class","graphdiagram");var n=gd.diagram().scaling(gd.scaling.centerOrScaleDiagramToFitSvg).nodeBehaviour(function(e){e.call(d3.behavior.drag().on("drag",a).on("dragend",f)).on("dblclick",l)}).relationshipBehaviour(function(e){e.on("dblclick",c)});var s=null;var o=null;d3.select("#add_node_button").on("click",function(){e.createNode().x(0).y(0);i(h());r()});d3.selectAll(".btn.cancel").on("click",p);var v=function(){d();d3.select(".modal.export-markup").classed("hide",false);var e=h();d3.select(".export-markup .modal-body textarea.code").attr("rows",e.split("\n").length*2).node().value=e};var m=function(){d3.select(".modal.help").classed("hide",false)};var g=function(){d3.select(".modal.help").classed("hide",true)};var b=function(t){var n=d3.select(t).node().value;e=y(n);i(n);r()};var w=function(){b(".export-markup .modal-body textarea.code");p()};d3.select("#save_markup").on("click",w);var E=function(){d3.xhr("graph-diagram-inverted.css",function(e){var t=e.responseText;var n=document.getElementById("canvas").innerHTML;var r='<style type="text/css"><![CDATA['+t+"]]></style>";var i='<svg xmlns="http://www.w3.org/2000/svg"';var s=n.replace(/<svg( [^>]*>)/,i+"$1"+r);window.open("data:image/svg+xml;base64,"+btoa(s))})};var S=function(e){var t=d3.select(".export-cypher .modal-body textarea.code").node().value;t=t.replace(/\n  /g," ");var n="http://console.neo4j.org"+"?init="+encodeURIComponent(t)+"&query="+encodeURIComponent("start n=node(*) return n");d3.select("#open_console").attr("href",n);return true};d3.select("#open_console").on("click",S);var x=function(){d();d3.select(".modal.export-cypher").classed("hide",false);var t=gd.cypher(e);d3.select(".export-cypher .modal-body textarea.code").attr("rows",t.split("\n").length).node().value=t};if(d3.select("#internalScale").node()){d3.select("#internalScale").node().value=e.internalScale();d3.select("#internalScale").on("change",T)}d3.select(window).on("resize",r);if(d3.select("#helpButton").node()){d3.select("#helpButton").on("mouseover",m).on("mouseout",g)}if(d3.select("#exportMarkupButton").node()){d3.select("#exportMarkupButton").on("click",v)}if(d3.select("#exportSvgButton").node()){d3.select("#exportSvgButton").on("click",E)}if(d3.select("#exportCypherButton").node()){d3.select("#exportCypherButton").on("click",x)}d3.selectAll(".modal-dialog").on("click",function(){d3.event.stopPropagation()});r();window.useMarkupFromSelection=b})()

gd={};(function(){gd.parameters={radius:50,nodeStrokeWidth:8,nodeStartMargin:15,nodeEndMargin:15,speechBubbleMargin:20,speechBubblePadding:10,speechBubbleStrokeWidth:3};gd.model=function(){function f(){while(e[n]){n++}return n}var e={},t=[],n=0,r=1,i=1;var s={};var o=function(){var e={};var t;var n=[];var i=new u;this.isNew=false;this.class=function(e){if(arguments.length==1){n=e.split(" ").filter(function(e){return e.length>0&&e!="node"});return this}return(this.isNew?["new","node"]:["node"]).concat(n)};this.x=function(t){if(arguments.length==1){e.x=Number(t);return this}return e.x};this.y=function(t){if(arguments.length==1){e.y=Number(t);return this}return e.y};this.ex=function(){return e.x*r};this.ey=function(){return e.y*r};this.distanceTo=function(e){var t=e.x()-this.x();var n=e.y()-this.y();return Math.sqrt(t*t+n*n)*r};this.drag=function(t,n){e.x+=t/r;e.y+=n/r};this.midwayTo=function(e){var t=e.x()-this.x();var n=e.y()-this.y();return{x:this.x()+t/2,y:this.y()+n/2}};this.angleTo=function(e){var t=e.x()-this.x();var n=e.y()-this.y();return Math.atan2(n,t)*180/Math.PI};this.isLeftOf=function(e){return this.x()<e.x()};this.label=function(e){if(arguments.length==1){t=e;return this}return t};this.properties=function(){return i}};var u=function(){var e=[];var t={};this.list=function(){return e.map(function(e){return{key:e,value:t[e]}})};this.set=function(n,r){if(!t[n]){e.push(n)}t[n]=r;return this};this.clearAll=function(){e=[];t={}}};var a=function(e,t){var n;var r=[];this.class=function(e){if(arguments.length==1){r=e.split(" ").filter(function(e){return e.length>0&&e!="relationship"});return this}return["relationship"].concat(r)};this.label=function(e){if(arguments.length==1){n=e;return this}return n};this.start=e;this.end=t};s.createNode=function(t){var n=t||f();var r=new o;r.id=n;e[n]=r;return r};s.deleteNode=function(n){t=t.filter(function(e){return!(e.start===n||e.end==n)});delete e[n.id]};s.createRelationship=function(e,n){var r=new a(e,n);t.push(r);return r};s.nodeList=function(){var t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push(e[n])}}return t};s.lookupNode=function(t){return e[t]};s.relationshipList=function(){return t};s.internalScale=function(e){if(arguments.length==1){r=parseFloat(e);return this}return r};s.externalScale=function(e){if(arguments.length==1){i=parseFloat(e);return this}return i};return s};gd.scaling=function(){function t(t){function n(e){return e.boundingBox}var r=e.boxUnion(t.nodeList().map(e.nodeBox).concat(t.nodeList().filter(gd.hasProperties).map(gd.speechBubble(t)).map(n).map(e.boxNormalise)));return{x:r.x1,y:r.y1,width:r.x2-r.x1,height:r.y2-r.y1}}var e={};e.nodeBox=function(e){var t=gd.parameters.radius+gd.parameters.nodeStrokeWidth/2;return{x1:e.ex()-t,y1:e.ey()-t,x2:e.ex()+t,y2:e.ey()+t}};e.boxNormalise=function(e){return{x1:e.width>0?e.x:e.x+e.width,y1:e.height>0?e.y:e.y+e.height,x2:e.width<0?e.x:e.x+e.width,y2:e.height<0?e.y:e.y+e.height}};e.boxUnion=function(e){if(e.length<1){return{x1:0,y1:0,x2:0,y2:0}}return e.reduce(function(e,t){return{x1:Math.min(e.x1,t.x1),y1:Math.min(e.y1,t.y1),x2:Math.max(e.x2,t.x2),y2:Math.max(e.y2,t.y2)}})};e.centeredOrScaledViewBox=function(e,t){var n=t.width/e.width;var r=t.height/e.height;var i=n<1&&r<1?1:n>r?n:r;var s={x:(t.width-e.width*i)/2+t.x,y:(t.height-e.height*i)/2+t.y,width:e.width*i,height:e.height*i};return s};e.centerOrScaleeDiagramToFitSvg=function(n,r){var i=r.node();var s={width:i.clientWidth,height:i.clientHeight};var o=t(n);var u=e.centeredOrScaledViewBox(s,o);r.attr("viewBox",[u.x,u.y,u.width,u.height].join(" "))};e.sizeSvgToFitDiagram=function(e,n){var r=t(e);n.attr("viewBox",[r.x,r.y,r.width,r.height].join(" ")).attr("width",r.width*e.externalScale()).attr("height",r.height*e.externalScale())};return e}();gd.markup=function(){var e={};e.parseAll=function(t){var n=[];t.each(function(){n.push(e.parse(d3.select(this)))});return n};e.parse=function(e){var t=gd.model();if(e.attr("data-internal-scale")){t.internalScale(e.attr("data-internal-scale"))}if(e.attr("data-external-scale")){t.externalScale(e.attr("data-external-scale"))}e.selectAll(".node").each(function(){var e=d3.select(this);var n=e.attr("data-node-id");var r=t.createNode(n);r.class(e.attr("class")||"");r.href=e.attr("href");r.x(e.attr("data-x"));r.y(e.attr("data-y"));e.select("span.caption").each(function(){r.label(d3.select(this).text())});e.select("dl.properties").each(function(){var e=d3.select(this).selectAll("dt, dd");var t;e.each(function(){if(this.nodeName.toLowerCase()==="dt"){t=d3.select(this).text()}else if(t&&this.nodeName.toLowerCase()==="dd"){r.properties().set(t,d3.select(this).text())}})})});e.selectAll(".relationship").each(function(){var e=d3.select(this);var n=e.attr("data-from");var r=e.attr("data-to");var i=t.createRelationship(t.lookupNode(n),t.lookupNode(r));i.class(e.attr("class")||"");e.select("span.type").each(function(){i.label(d3.select(this).text())})});return t};e.format=function(e,t){var n=t.append("ul").attr("class","graph-diagram-markup").attr("data-internal-scale",e.internalScale()).attr("data-external-scale",e.externalScale());e.nodeList().forEach(function(e){var t=n.append("li").attr("class",e.class().join(" ")).attr("data-node-id",e.id).attr("data-x",e.x()).attr("data-y",e.y());if(e.label()){t.append("span").attr("class","caption").text(e.label())}if(e.properties().list().length>0){var r=t.append("dl").attr("class","properties");e.properties().list().forEach(function(e){r.append("dt").text(e.key);r.append("dd").text(e.value)})}});e.relationshipList().forEach(function(e){var t=n.append("li").attr("class",e.class().join(" ")).attr("data-from",e.start.id).attr("data-to",e.end.id);if(e.label()){t.append("span").attr("class","type").text(e.label())}})};return e}();gd.horizontalArrowOutline=function(e,t){var n=4;var r=15;var i=30;var s=e<t?t-i:t+i;return["M",e,n,"L",s,n,"L",s,r,"L",t,0,"L",s,-r,"L",s,-n,"L",e,-n,"Z"].join(" ")};gd.chooseSpeechBubbleOrientation=function(e,t){var n=[{key:"WEST",style:"horizontal",mirrorX:-1,mirrorY:1,angle:180},{key:"NORTH-WEST",style:"diagonal",mirrorX:-1,mirrorY:-1,angle:-135},{key:"NORTH",style:"vertical",mirrorX:1,mirrorY:-1,angle:-90},{key:"NORTH-EAST",style:"diagonal",mirrorX:1,mirrorY:-1,angle:-45},{key:"EAST",style:"horizontal",mirrorX:1,mirrorY:1,angle:0},{key:"SOUTH-EAST",style:"diagonal",mirrorX:1,mirrorY:1,angle:45},{key:"SOUTH",style:"vertical",mirrorX:1,mirrorY:1,angle:90},{key:"SOUTH-WEST",style:"diagonal",mirrorX:-1,mirrorY:1,angle:135}];n.forEach(function(e){e.closest=180});t.forEach(function(t){n.forEach(function(n){var r=Math.abs(e.angleTo(t)-n.angle);if(r>180)r=360-r;if(r<n.closest){n.closest=r}})});var r=0;var i=n[0];n.forEach(function(e){if(e.closest>r){r=e.closest;i=e}});return i};gd.speechBubblePath=function(e,t,n,r){var i=e.width,s=e.height;var o={diagonal:["M",0,0,"L",n+r,n,"L",n+i+r,n,"A",r,r,0,0,1,n+i+r*2,n+r,"L",n+i+r*2,n+s+r,"A",r,r,0,0,1,n+i+r,n+s+r*2,"L",n+r,n+s+r*2,"A",r,r,0,0,1,n,n+s+r,"L",n,n+r,"Z"],horizontal:["M",0,0,"L",n,-r,"L",n,-s/2,"A",r,r,0,0,1,n+r,-s/2-r,"L",n+i+r,-s/2-r,"A",r,r,0,0,1,n+i+r*2,-s/2,"L",n+i+r*2,s/2,"A",r,r,0,0,1,n+i+r,s/2+r,"L",n+r,s/2+r,"A",r,r,0,0,1,n,s/2,"L",n,r,"Z"],vertical:["M",0,0,"L",-r,n,"L",-i/2,n,"A",r,r,0,0,0,-i/2-r,n+r,"L",-i/2-r,n+s+r,"A",r,r,0,0,0,-i/2,n+s+r*2,"L",i/2,n+s+r*2,"A",r,r,0,0,0,i/2+r,n+s+r,"L",i/2+r,n+r,"A",r,r,0,0,0,i/2,n,"L",r,n,"Z"]};return o[t].join(" ")};gd.speechBubble=function(e){return function(t){var n=[];e.relationshipList().forEach(function(e){if(e.start===t){n.push(e.end)}if(e.end===t){n.push(e.start)}});var r=gd.chooseSpeechBubbleOrientation(t,n);var i=d3.max(t.properties().list(),function(e){return gd.textDimensions.measure(e.key+": ")});var s=d3.max(t.properties().list(),function(e){return gd.textDimensions.measure(e.value)});var o={width:i+s,height:t.properties().list().length*50};var u="scale("+r.mirrorX+","+r.mirrorY+") ";var a=gd.parameters.radius*Math.sqrt(2)/2;var f={diagonal:{attach:{x:a,y:a},textCorner:{x:gd.parameters.speechBubbleMargin+gd.parameters.speechBubblePadding,y:gd.parameters.speechBubbleMargin+gd.parameters.speechBubblePadding}},horizontal:{attach:{x:gd.parameters.radius,y:0},textCorner:{x:gd.parameters.speechBubbleMargin+gd.parameters.speechBubblePadding,y:-o.height/2}},vertical:{attach:{x:0,y:gd.parameters.radius},textCorner:{x:-o.width/2,y:gd.parameters.speechBubbleMargin+gd.parameters.speechBubblePadding}}};var l=f[r.style].attach;var c=f[r.style].textCorner;var h="translate("+(t.ex()+l.x*r.mirrorX)+","+(t.ey()+l.y*r.mirrorY)+") ";var p={x:i+r.mirrorX*c.x-(r.mirrorX==-1?o.width:0),y:r.mirrorY*c.y-(r.mirrorY==-1?o.height:0)};var d=gd.parameters.speechBubblePadding+gd.parameters.speechBubbleStrokeWidth/2;var v={x:t.ex()+(l.x+c.x-d)*r.mirrorX,y:t.ey()+(l.y+c.y-d)*r.mirrorY,width:r.mirrorX*(o.width+d*2),height:r.mirrorY*(o.height+d*2)};return{properties:t.properties().list().map(function(e){return{keyText:e.key+": ",valueText:e.value,textOrigin:p}}),groupTransform:h,outlineTransform:u,outlinePath:gd.speechBubblePath(o,r.style,gd.parameters.speechBubbleMargin,gd.parameters.speechBubblePadding),boundingBox:v}}};gd.textDimensions=function(){var e={};e.measure=function(e){var t=d3.select("#textMeasuringCanvas").data([this]);t.enter().append("canvas").attr("id","textMeasuringCanvas");var n=t.node();var r=n.getContext("2d");r.font="normal normal normal 50px/normal Gill Sans";return r.measureText(e).width};return e}();gd.hasProperties=function(e){return e.properties().list().length>0};gd.diagram=function(){var e=function(){};var t=function(){};var n=gd.scaling.sizeSvgToFitDiagram;var r=function(r){r.each(function(r){function s(e){return e.ex()}function o(e){return e.ey()}function u(e){return e.label()}function a(e){return e.href}function f(e){return e.class().join(" ")+" "+"node-id-"+e.id}function c(e){var t=e.start.distanceTo(e.end);var n=e.end.isLeftOf(e.start)?-1:1;return gd.horizontalArrowOutline(n*(gd.parameters.radius+gd.parameters.nodeStartMargin),n*(t-(gd.parameters.radius+gd.parameters.nodeEndMargin)))}function h(e){var t=e.start.distanceTo(e.end);var n=e.end.isLeftOf(e.start)?-1:1;return n*t/2}function p(e){var t=e.start.angleTo(e.end);if(e.end.isLeftOf(e.start)){t+=180}return"translate("+e.start.ex()+","+e.start.ey()+") rotate("+t+")"}function d(e){return e.class().join(" ")}function m(e){return[e]}function y(e){return[e].filter(u)}function w(e){function t(t){return e+" "+t.class()}var n=d3.values(r.nodeList());i.selectAll("text."+e).remove();var f=i.selectAll("text."+e).data(n.filter(u));f.enter().append("svg:text").attr("class",t);f.attr("x",s).attr("y",o);if(e=="caption"){f.append("svg:a").attr("xlink:href",a).text(u)}else{f.text(u)}}var i=d3.select(this);var l=i.selectAll("circle.node").data(d3.values(r.nodeList()));l.exit().remove();l.enter().append("svg:circle").attr("class",f).attr("r",gd.parameters.radius).call(e);l.attr("cx",s).attr("cy",o);var v=i.selectAll("g.relationship").data(r.relationshipList());v.exit().remove();v.enter().append("svg:g").attr("class",d);v.attr("transform",p);var g=v.selectAll("path.relationship").data(m);g.enter().append("svg:path").attr("class",d).call(t);g.attr("d",c);var b=v.selectAll("text.type").data(y);b.exit().remove();b.enter().append("svg:text").attr("class","type").call(t);b.attr("x",h).attr("y",0).text(u);w("caption-shadow");w("caption");var E=i.selectAll("g.speech-bubble").data(d3.values(r.nodeList()).filter(gd.hasProperties).map(gd.speechBubble(r)));E.exit().remove();E.enter().append("svg:g").attr("class","speech-bubble");E.attr("transform",function(e){return e.groupTransform});var S=E.selectAll("path.speech-bubble-outline").data(m);S.exit().remove();S.enter().append("svg:path").attr("class","speech-bubble-outline");S.attr("transform",function(e){return e.outlineTransform}).attr("d",function(e){return e.outlinePath});var x=E.selectAll("text.speech-bubble-content.property-key").data(function(e){return e.properties});x.exit().remove();x.enter().append("svg:text").attr("class","speech-bubble-content property-key");x.attr("x",function(e){return e.textOrigin.x-10}).attr("y",function(e,t){return t*50+e.textOrigin.y+25}).text(function(e){return e.keyText});var T=E.selectAll("text.speech-bubble-content.property-value").data(function(e){return e.properties});T.exit().remove();T.enter().append("svg:text").attr("class","speech-bubble-content property-value");T.attr("x",function(e){return e.textOrigin.x}).attr("y",function(e,t){return t*50+e.textOrigin.y+25}).text(function(e){return e.valueText});n(r,i)})};r.nodeBehaviour=function(t){e=t;return r};r.relationshipBehaviour=function(e){t=e;return r};r.scaling=function(e){scaling=e;return this};return r}})()